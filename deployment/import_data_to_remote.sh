#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑—ã –≤ —É–¥–∞–ª–µ–Ω–Ω—É—é
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./import_data_to_remote.sh

set -e

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}üöÄ –ù–∞—á–∏–Ω–∞–µ–º –∏–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ —É–¥–∞–ª–µ–Ω–Ω—É—é –±–∞–∑—É...${NC}"

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ -f "deploy.env" ]; then
    source deploy.env
else
    echo -e "${RED}‚ùå –§–∞–π–ª deploy.env –Ω–µ –Ω–∞–π–¥–µ–Ω!${NC}"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ —Å –¥–∞–Ω–Ω—ã–º–∏
if [ ! -f "local_data_export.sql" ]; then
    echo -e "${RED}‚ùå –§–∞–π–ª local_data_export.sql –Ω–µ –Ω–∞–π–¥–µ–Ω!${NC}"
    echo -e "${YELLOW}üí° –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑—ã${NC}"
    exit 1
fi

echo -e "${GREEN}üì§ –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä...${NC}"

# –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
scp -i "$SSH_KEY_PATH" local_data_export.sql "$REMOTE_USER@$REMOTE_HOST:$REMOTE_DEPLOY_DIR/"

echo -e "${GREEN}‚úÖ –§–∞–π–ª —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä${NC}"

echo -e "${GREEN}üóÑÔ∏è –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —É–¥–∞–ª–µ–Ω–Ω—É—é –±–∞–∑—É...${NC}"

# –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —É–¥–∞–ª–µ–Ω–Ω–æ–º—É —Å–µ—Ä–≤–µ—Ä—É –∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
ssh -i "$SSH_KEY_PATH" "$REMOTE_USER@$REMOTE_HOST" << 'EOF'
    cd /opt/alex-orator-bot
    
    echo "üîÑ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞..."
    docker-compose down
    
    echo "üóÑÔ∏è –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –±–∞–∑—É..."
    docker-compose up -d app-db
    
    # –ñ–¥–µ–º, –ø–æ–∫–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è
    echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
    sleep 10
    
    # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
    echo "üì• –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º bot_content –∏ topics..."
    docker exec alex-orator-bot-app-db psql -U alex_orator -d app_db -c "DELETE FROM bot_content;"
    docker exec alex-orator-bot-app-db psql -U alex_orator -d app_db -c "DELETE FROM topics;"
    docker exec -i alex-orator-bot-app-db psql -U alex_orator -d app_db < local_data_export.sql
    
    echo "‚úÖ –î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã"
    
    echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã..."
    docker-compose up -d
    
    echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
    sleep 15
    
    echo "üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤..."
    docker-compose ps
    
    echo "üßπ –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã..."
    rm -f local_data_export.sql
EOF

echo -e "${GREEN}‚úÖ –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–µ–Ω!${NC}"
echo -e "${YELLOW}üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–∏—Å–æ–≤:${NC}"
echo -e "${YELLOW}   docker-compose logs backend${NC}"
echo -e "${YELLOW}   docker-compose logs telegram-bot${NC}" 